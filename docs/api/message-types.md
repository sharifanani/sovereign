# Sovereign Message Types

**Version**: 1.0
**Last Updated**: 2026-02-16

This document defines all message types exchanged over the Sovereign WebSocket protocol. Each message is carried as the `payload` field within an `Envelope`, with the `type` field indicating which message definition to use for deserialization.

**Direction Legend:**
- **C->S**: Client to Server
- **S->C**: Server to Client
- **Bi**: Bidirectional

---

## Authentication

Authentication messages handle user login and registration using the Passkey/WebAuthn protocol. These are the only messages permitted before the connection enters the READY state.

---

### `auth.request`

**Direction**: C->S
**Description**: Initiates a login flow. The client provides a username and the server responds with a WebAuthn challenge.

| Field      | Type     | Required | Description                                      |
|-----------|----------|----------|--------------------------------------------------|
| `username`| `string` | Yes      | The username of the account to authenticate as.  |

**Behavior**:
- Server looks up the user by username.
- If the user exists and is enabled, the server generates a WebAuthn challenge and responds with `auth.challenge`.
- If the user does not exist, the server responds with `auth.error` (code `1001`).
- If the user account is disabled, the server responds with `auth.error` (code `2004`).

---

### `auth.challenge`

**Direction**: S->C
**Description**: Server sends a WebAuthn authentication challenge for the client to sign.

| Field                        | Type    | Required | Description                                                       |
|-----------------------------|---------|----------|-------------------------------------------------------------------|
| `challenge`                 | `bytes` | Yes      | Random challenge bytes generated by the server.                   |
| `credential_request_options`| `bytes` | Yes      | Serialized JSON of the WebAuthn `PublicKeyCredentialRequestOptions`. Contains allowed credentials, relying party ID, and other parameters needed by the browser's WebAuthn API. |

**Behavior**:
- The client passes `credential_request_options` to the browser's `navigator.credentials.get()` API.
- The user performs the authentication gesture (biometric, PIN, etc.).
- The client sends the resulting assertion in `auth.response`.

---

### `auth.response`

**Direction**: C->S
**Description**: Client sends the signed WebAuthn assertion.

| Field               | Type    | Required | Description                                                   |
|--------------------|---------|----------|---------------------------------------------------------------|
| `credential_id`    | `bytes` | Yes      | The ID of the credential used to sign the challenge.          |
| `authenticator_data`| `bytes`| Yes      | Authenticator data from the WebAuthn assertion.               |
| `client_data_json` | `bytes` | Yes      | Client data JSON from the WebAuthn assertion.                 |
| `signature`        | `bytes` | Yes      | The signature over the challenge, produced by the authenticator.|

**Behavior**:
- Server verifies the WebAuthn assertion against the stored public key for the credential.
- On success, the server creates a session and responds with `auth.success`.
- On failure, the server responds with `auth.error` (code `1004`).

---

### `auth.success`

**Direction**: S->C
**Description**: Authentication succeeded. The connection is now in the READY state.

| Field           | Type     | Required | Description                                           |
|----------------|----------|----------|-------------------------------------------------------|
| `session_token`| `string` | Yes      | Opaque session token for reconnection.                |
| `user_id`      | `string` | Yes      | Unique identifier for the authenticated user.         |
| `username`     | `string` | Yes      | The user's username.                                  |
| `display_name` | `string` | Yes      | The user's display name.                              |

**Behavior**:
- The client stores the `session_token` for use in reconnection.
- The connection transitions to the READY state.
- The server begins delivering queued messages and presence notifications.

---

### `auth.error`

**Direction**: S->C
**Description**: Authentication failed.

| Field        | Type     | Required | Description                                       |
|-------------|----------|----------|---------------------------------------------------|
| `error_code`| `int32`  | Yes      | Numeric error code (see error-codes.md).          |
| `message`   | `string` | Yes      | Human-readable error description.                 |

**Behavior**:
- If the error is fatal (e.g., account disabled), the server closes the WebSocket connection after sending this message.
- If the error is non-fatal (e.g., invalid credential), the client may retry authentication.

---

### `auth.register.request`

**Direction**: C->S
**Description**: Initiates a new user registration flow.

| Field          | Type     | Required | Description                                    |
|---------------|----------|----------|------------------------------------------------|
| `username`    | `string` | Yes      | Desired username. Must be unique.              |
| `display_name`| `string` | Yes      | User's display name shown to other users.      |

**Behavior**:
- Server checks if the username is available.
- If available, server generates a WebAuthn credential creation challenge and responds with `auth.register.challenge`.
- If the username is taken, server responds with `auth.error` (code `1003`).

---

### `auth.register.challenge`

**Direction**: S->C
**Description**: Server sends a WebAuthn credential creation challenge.

| Field                          | Type    | Required | Description                                                         |
|-------------------------------|---------|----------|---------------------------------------------------------------------|
| `challenge`                   | `bytes` | Yes      | Random challenge bytes generated by the server.                     |
| `credential_creation_options` | `bytes` | Yes      | Serialized JSON of the WebAuthn `PublicKeyCredentialCreationOptions`. Contains relying party info, user info, and supported algorithms. |

**Behavior**:
- The client passes `credential_creation_options` to the browser's `navigator.credentials.create()` API.
- The user creates a new credential (biometric enrollment, PIN setup, etc.).
- The client sends the result in `auth.register.response`.

---

### `auth.register.response`

**Direction**: C->S
**Description**: Client sends the newly created WebAuthn credential.

| Field                | Type    | Required | Description                                                 |
|---------------------|---------|----------|-------------------------------------------------------------|
| `credential_id`     | `bytes` | Yes      | The ID of the newly created credential.                     |
| `authenticator_data`| `bytes` | Yes      | Authenticator data from the credential creation.            |
| `client_data_json`  | `bytes` | Yes      | Client data JSON from the credential creation.              |
| `attestation_object`| `bytes` | Yes      | Attestation object containing the public key and attestation statement. |

**Behavior**:
- Server verifies the attestation and extracts the public key.
- Server creates the user account and stores the credential.
- On success, server responds with `auth.register.success`.
- On failure, server responds with `auth.error` (code `1003`).

---

### `auth.register.success`

**Direction**: S->C
**Description**: Registration succeeded. The user is now authenticated and the connection is in the READY state.

| Field           | Type     | Required | Description                                           |
|----------------|----------|----------|-------------------------------------------------------|
| `user_id`      | `string` | Yes      | Unique identifier for the newly created user.         |
| `session_token`| `string` | Yes      | Opaque session token for reconnection.                |

**Behavior**:
- The client stores the `session_token` for use in reconnection.
- The connection transitions to the READY state.

---

## Messaging

Messaging types handle the sending, receiving, and acknowledgment of end-to-end encrypted messages. All message content is encrypted using MLS (RFC 9420) and is opaque to the server.

---

### `message.send`

**Direction**: C->S
**Description**: Client sends an encrypted message to a conversation.

| Field               | Type     | Required | Description                                                    |
|--------------------|----------|----------|----------------------------------------------------------------|
| `conversation_id`  | `string` | Yes      | The ID of the conversation (1:1 or group) to send to.         |
| `encrypted_payload`| `bytes`  | Yes      | MLS ciphertext. The server cannot read the content.            |
| `message_type`     | `string` | Yes      | Hint for the client UI. One of: `text`, `image`, `file`, `audio`, `video`, `reaction`, `reply`, `edit`, `delete`. The server does not interpret this field. |

**Behavior**:
- Server validates that the sender is a member of the conversation.
- Server assigns a `message_id` and `server_timestamp`.
- Server stores the encrypted message for delivery.
- Server delivers the message to all other members of the conversation (online members immediately, offline members on reconnection).
- Server responds with `message.receive` echoed back to the sender as delivery confirmation, containing the assigned `message_id` and `server_timestamp`.

---

### `message.receive`

**Direction**: S->C
**Description**: Server delivers an encrypted message to the client.

| Field               | Type     | Required | Description                                                    |
|--------------------|----------|----------|----------------------------------------------------------------|
| `message_id`       | `string` | Yes      | Unique identifier for this message, assigned by the server.    |
| `conversation_id`  | `string` | Yes      | The conversation this message belongs to.                      |
| `sender_id`        | `string` | Yes      | The user ID of the message sender.                             |
| `encrypted_payload`| `bytes`  | Yes      | MLS ciphertext. Decrypt using the conversation's MLS group state. |
| `server_timestamp` | `int64`  | Yes      | Server-assigned timestamp in Unix microseconds.                |
| `message_type`     | `string` | Yes      | Message type hint (same as in `message.send`).                 |

**Behavior**:
- The client decrypts `encrypted_payload` using the MLS group state for the conversation.
- The client sends `message.ack` to confirm receipt.
- The client inserts the message at the correct position based on `server_timestamp`.

---

### `message.ack`

**Direction**: C->S
**Description**: Client acknowledges receipt of a message. This prevents the server from re-delivering the message on reconnection.

| Field        | Type     | Required | Description                                    |
|-------------|----------|----------|------------------------------------------------|
| `message_id`| `string` | Yes      | The ID of the message being acknowledged.      |

**Behavior**:
- Server marks the message as delivered to this client.
- Server does not re-send this message on future reconnections.
- No response is sent to the client.

---

### `message.delivered`

**Direction**: S->C
**Description**: Notifies the sender that their message has been delivered to a recipient.

| Field          | Type     | Required | Description                                         |
|---------------|----------|----------|-----------------------------------------------------|
| `message_id`  | `string` | Yes      | The ID of the delivered message.                    |
| `delivered_to`| `string` | Yes      | The user ID of the recipient who received the message. |

**Behavior**:
- Sent to the original sender of the message when a recipient acknowledges it.
- The client may use this to display delivery indicators (e.g., check marks).
- This message does not require acknowledgment.

---

## Groups

Group messages manage the lifecycle of group conversations. MLS group state management is handled separately via MLS messages.

---

### `group.create`

**Direction**: C->S
**Description**: Create a new group conversation.

| Field        | Type       | Required | Description                                          |
|-------------|------------|----------|------------------------------------------------------|
| `title`     | `string`   | Yes      | Display title for the group.                         |
| `member_ids`| `string[]` | Yes      | List of user IDs to add as initial members. The creator is automatically included. |

**Behavior**:
- Server creates a new conversation with the specified members.
- Server responds with `group.created`.
- Server sends `group.member_added` to all members.
- The creator is assigned as the group admin.
- The client should subsequently create an MLS group and distribute Welcome messages to all members.

---

### `group.created`

**Direction**: S->C
**Description**: Confirms group creation. Sent to the creator.

| Field             | Type       | Required | Description                                    |
|------------------|------------|----------|------------------------------------------------|
| `conversation_id`| `string`   | Yes      | The unique ID assigned to the new group.       |
| `title`          | `string`   | Yes      | The group title.                               |
| `members`        | `Member[]` | Yes      | List of group members with their details.      |

**Member object:**

| Field          | Type     | Description                    |
|---------------|----------|--------------------------------|
| `user_id`     | `string` | The member's user ID.          |
| `username`    | `string` | The member's username.         |
| `display_name`| `string` | The member's display name.     |
| `role`        | `string` | Either `admin` or `member`.    |

---

### `group.invite`

**Direction**: C->S
**Description**: Invite a user to an existing group.

| Field             | Type     | Required | Description                                    |
|------------------|----------|----------|------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation ID.                     |
| `user_id`        | `string` | Yes      | The user ID of the person to invite.           |

**Behavior**:
- Server validates that the sender is an admin of the group.
- Server adds the user to the group.
- Server sends `group.member_added` to all group members.
- The inviter should subsequently send an MLS Welcome message to the new member.

---

### `group.member_added`

**Direction**: S->C
**Description**: Notifies group members that a new member has been added.

| Field             | Type     | Required | Description                                    |
|------------------|----------|----------|------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation ID.                     |
| `user_id`        | `string` | Yes      | The user ID of the newly added member.         |
| `added_by`       | `string` | Yes      | The user ID of the person who added them.      |

**Behavior**:
- Sent to all current members of the group, including the newly added member.

---

### `group.member_removed`

**Direction**: S->C
**Description**: Notifies group members that a member has been removed.

| Field             | Type     | Required | Description                                      |
|------------------|----------|----------|--------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation ID.                       |
| `user_id`        | `string` | Yes      | The user ID of the removed member.               |
| `removed_by`     | `string` | Yes      | The user ID of the person who removed them.      |

**Behavior**:
- Sent to all remaining members of the group and to the removed member.
- The group admin should subsequently send an MLS Commit to update the group state.

---

### `group.leave`

**Direction**: C->S
**Description**: Client voluntarily leaves a group conversation.

| Field             | Type     | Required | Description                            |
|------------------|----------|----------|----------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation ID to leave.    |

**Behavior**:
- Server removes the user from the group.
- Server sends `group.member_removed` to all remaining members.
- If the leaving user is the group admin, the server assigns admin role to the longest-standing member.
- The departing member's client should send an MLS Commit removing themselves before leaving.

---

## MLS Key Management

MLS (Messaging Layer Security, RFC 9420) messages handle the cryptographic group state for end-to-end encryption. The server acts as a delivery service for MLS protocol messages but cannot read their contents or derive encryption keys.

---

### `mls.key_package.upload`

**Direction**: C->S
**Description**: Client uploads an MLS KeyPackage to the server. KeyPackages are consumed when other users add this client to a group.

| Field              | Type    | Required | Description                                              |
|-------------------|---------|----------|----------------------------------------------------------|
| `key_package_data`| `bytes` | Yes      | Serialized MLS KeyPackage as defined in RFC 9420.        |

**Behavior**:
- Server validates the KeyPackage format (but cannot verify cryptographic contents beyond structure).
- Server stores the KeyPackage, associated with the uploading user.
- Each client should maintain a pool of available KeyPackages. The server notifies the client when the pool is running low.
- No explicit response; errors are communicated via `error` messages.

---

### `mls.key_package.fetch`

**Direction**: C->S
**Description**: Client requests a KeyPackage for another user in order to add them to a group.

| Field     | Type     | Required | Description                                         |
|----------|----------|----------|-----------------------------------------------------|
| `user_id`| `string` | Yes      | The user ID whose KeyPackage is being requested.    |

**Behavior**:
- Server retrieves and removes (consumes) one KeyPackage for the requested user.
- Server responds with `mls.key_package.response`.
- If no KeyPackage is available, server responds with error code `5005 (NoKeyPackageAvailable)`.

---

### `mls.key_package.response`

**Direction**: S->C
**Description**: Server returns a KeyPackage for the requested user.

| Field              | Type     | Required | Description                                        |
|-------------------|----------|----------|----------------------------------------------------|
| `user_id`         | `string` | Yes      | The user ID the KeyPackage belongs to.             |
| `key_package_data`| `bytes`  | Yes      | Serialized MLS KeyPackage.                         |

---

### `mls.welcome`

**Direction**: C->S
**Description**: Client sends an MLS Welcome message to a new group member. The Welcome contains the information needed for the recipient to join the MLS group.

| Field             | Type     | Required | Description                                              |
|------------------|----------|----------|----------------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation the Welcome is for.               |
| `recipient_id`   | `string` | Yes      | The user ID of the new member receiving the Welcome.     |
| `welcome_data`   | `bytes`  | Yes      | Serialized MLS Welcome message as defined in RFC 9420.   |

**Behavior**:
- Server forwards the Welcome to the specified recipient.
- Server does not interpret or modify the Welcome data.

---

### `mls.welcome.receive`

**Direction**: S->C
**Description**: Server delivers an MLS Welcome message to the client.

| Field             | Type     | Required | Description                                              |
|------------------|----------|----------|----------------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation the Welcome is for.               |
| `sender_id`      | `string` | Yes      | The user ID who sent the Welcome (the person who added this client to the group). |
| `welcome_data`   | `bytes`  | Yes      | Serialized MLS Welcome message.                         |

**Behavior**:
- The client processes the Welcome to join the MLS group and establish shared encryption state.

---

### `mls.commit`

**Direction**: C->S
**Description**: Client sends an MLS Commit to the server for distribution to the group. Commits update the group's cryptographic state (e.g., adding/removing members, updating keys).

| Field             | Type     | Required | Description                                                |
|------------------|----------|----------|------------------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation the Commit applies to.              |
| `commit_data`    | `bytes`  | Yes      | Serialized MLS Commit message as defined in RFC 9420.      |

**Behavior**:
- Server broadcasts the Commit to all other members of the group via `mls.commit.broadcast`.
- Server does not interpret or modify the Commit data.

---

### `mls.commit.broadcast`

**Direction**: S->C
**Description**: Server broadcasts an MLS Commit to group members.

| Field             | Type     | Required | Description                                                |
|------------------|----------|----------|------------------------------------------------------------|
| `conversation_id`| `string` | Yes      | The group conversation the Commit applies to.              |
| `sender_id`      | `string` | Yes      | The user ID who sent the Commit.                           |
| `commit_data`    | `bytes`  | Yes      | Serialized MLS Commit message.                             |

**Behavior**:
- The client processes the Commit to update its local MLS group state.
- If processing fails (e.g., epoch mismatch), the client should request the current group state from the server.

---

## Presence

Presence messages track user online status.

---

### `presence.update`

**Direction**: C->S
**Description**: Client updates its presence status.

| Field    | Type     | Required | Description                                                |
|---------|----------|----------|------------------------------------------------------------|
| `status`| `string` | Yes      | One of: `online`, `away`, `offline`. Setting `offline` is equivalent to graceful disconnect from a presence perspective. |

**Behavior**:
- Server updates the user's presence status.
- Server broadcasts `presence.notify` to all users who have this user in their contact list or share a group conversation.

---

### `presence.notify`

**Direction**: S->C
**Description**: Server notifies the client of another user's presence change.

| Field     | Type     | Required | Description                                    |
|----------|----------|----------|------------------------------------------------|
| `user_id`| `string` | Yes      | The user whose presence changed.               |
| `status` | `string` | Yes      | The new status: `online`, `away`, or `offline`.|

**Behavior**:
- The client updates the UI to reflect the user's new status.
- Presence notifications are best-effort and not guaranteed to be delivered.

---

## System

System messages handle connection health and error reporting.

---

### `ping`

**Direction**: C->S
**Description**: Heartbeat ping. The client sends this periodically to verify connection liveness.

| Field       | Type    | Required | Description                                          |
|------------|---------|----------|------------------------------------------------------|
| `timestamp`| `int64` | Yes      | Client's current timestamp in Unix microseconds.     |

**Behavior**:
- Server responds with `pong`, echoing the timestamp.
- If the server does not receive any message (including `ping`) from a client for 90 seconds, it closes the connection.

---

### `pong`

**Direction**: S->C
**Description**: Heartbeat pong. The server echoes the client's ping.

| Field       | Type    | Required | Description                                          |
|------------|---------|----------|------------------------------------------------------|
| `timestamp`| `int64` | Yes      | The timestamp from the client's `ping`, echoed back. |

**Behavior**:
- If the client does not receive a `pong` within 10 seconds of sending a `ping`, it considers the connection dead and initiates reconnection.

---

### `error`

**Direction**: S->C
**Description**: Server reports an error to the client.

| Field     | Type     | Required | Description                                                    |
|----------|----------|----------|----------------------------------------------------------------|
| `code`   | `int32`  | Yes      | Numeric error code. See error-codes.md for the full list.      |
| `message`| `string` | Yes      | Human-readable error description.                              |
| `fatal`  | `bool`   | Yes      | If `true`, the server will close the connection after sending this message. The client should not attempt to send further messages. |

**Behavior**:
- Non-fatal errors: The client should handle the error gracefully and may continue using the connection.
- Fatal errors: The client should expect the connection to close immediately and initiate reconnection (if appropriate).

---

## Appendix: MessageType Enum Summary

| Enum Value                    | Message Type             | Direction |
|------------------------------|--------------------------|-----------|
| `AUTH_REQUEST`               | `auth.request`           | C->S      |
| `AUTH_CHALLENGE`             | `auth.challenge`         | S->C      |
| `AUTH_RESPONSE`              | `auth.response`          | C->S      |
| `AUTH_SUCCESS`               | `auth.success`           | S->C      |
| `AUTH_ERROR`                 | `auth.error`             | S->C      |
| `AUTH_REGISTER_REQUEST`      | `auth.register.request`  | C->S      |
| `AUTH_REGISTER_CHALLENGE`    | `auth.register.challenge`| S->C      |
| `AUTH_REGISTER_RESPONSE`     | `auth.register.response` | C->S      |
| `AUTH_REGISTER_SUCCESS`      | `auth.register.success`  | S->C      |
| `MESSAGE_SEND`               | `message.send`           | C->S      |
| `MESSAGE_RECEIVE`            | `message.receive`        | S->C      |
| `MESSAGE_ACK`                | `message.ack`            | C->S      |
| `MESSAGE_DELIVERED`          | `message.delivered`      | S->C      |
| `GROUP_CREATE`               | `group.create`           | C->S      |
| `GROUP_CREATED`              | `group.created`          | S->C      |
| `GROUP_INVITE`               | `group.invite`           | C->S      |
| `GROUP_MEMBER_ADDED`         | `group.member_added`     | S->C      |
| `GROUP_MEMBER_REMOVED`       | `group.member_removed`   | S->C      |
| `GROUP_LEAVE`                | `group.leave`            | C->S      |
| `MLS_KEY_PACKAGE_UPLOAD`     | `mls.key_package.upload` | C->S      |
| `MLS_KEY_PACKAGE_FETCH`      | `mls.key_package.fetch`  | C->S      |
| `MLS_KEY_PACKAGE_RESPONSE`   | `mls.key_package.response`| S->C     |
| `MLS_WELCOME`                | `mls.welcome`            | C->S      |
| `MLS_WELCOME_RECEIVE`        | `mls.welcome.receive`    | S->C      |
| `MLS_COMMIT`                 | `mls.commit`             | C->S      |
| `MLS_COMMIT_BROADCAST`       | `mls.commit.broadcast`   | S->C      |
| `PRESENCE_UPDATE`            | `presence.update`        | C->S      |
| `PRESENCE_NOTIFY`            | `presence.notify`        | S->C      |
| `PING`                       | `ping`                   | C->S      |
| `PONG`                       | `pong`                   | S->C      |
| `ERROR`                      | `error`                  | S->C      |
