# ADR-0009: modernc.org/sqlite (CGo-Free SQLite)

- **Status**: Accepted
- **Date**: 2026-02-16

## Context

ADR-0004 establishes SQLite as the database for Sovereign. The most widely used Go SQLite driver is `mattn/go-sqlite3`, which uses CGo to call the SQLite C library. However, CGo introduces significant complications:

- **Cross-compilation breaks**: CGo requires a C cross-compiler for the target platform. Building a Linux binary on macOS requires a Linux C toolchain, making `GOOS=linux GOARCH=arm64 go build` fail.
- **Single binary goal**: CGo can introduce dynamic library dependencies, undermining the single-binary deployment goal.
- **Build complexity**: CGo requires a C compiler in the build environment, complicating CI and developer setup.
- **Build speed**: CGo builds are significantly slower due to the C compilation step.

ADR-0002 establishes a no-CGo policy for the server. We need an SQLite driver that complies with this policy.

Alternatives considered:

- **mattn/go-sqlite3**: The most popular Go SQLite driver. Full-featured and well-maintained, but requires CGo. Violates our no-CGo policy.
- **crawshaw.io/sqlite**: Another CGo-based SQLite binding for Go. Same CGo issues as mattn/go-sqlite3.
- **cznic/sqlite (modernc.org/sqlite)**: A pure Go translation of the SQLite C source code, generated by a C-to-Go transpiler. No CGo required.

## Decision

We will use **modernc.org/sqlite** as the SQLite driver for the Sovereign server.

`modernc.org/sqlite` is a pure Go translation of the SQLite C source code, produced by the `ccgo` C-to-Go transpiler. It provides full SQLite compatibility (including WAL mode, FTS5, JSON1) without any CGo dependency. It exposes a `database/sql`-compatible driver, making it a drop-in replacement for `mattn/go-sqlite3` at the API level.

Import path: `modernc.org/sqlite`
Driver registration: `import _ "modernc.org/sqlite"`
DSN format: `file:sovereign.db?_journal_mode=WAL&_busy_timeout=5000`

## Consequences

### Positive

- **True single binary**: No C compiler, no dynamic libraries, no CGo. `go build` produces a fully self-contained binary.
- **Easy cross-compilation**: `GOOS=linux GOARCH=arm64 go build` works without any C cross-compilation toolchain.
- **No C toolchain dependency**: CI pipelines and developer machines do not need GCC, clang, or any C compiler installed.
- **Full SQLite compatibility**: The transpiled code passes SQLite's own test suite. WAL mode, FTS5, JSON1 extensions are all available.
- **`database/sql` compatible**: Uses Go's standard `database/sql` interface. If we ever need to switch drivers, the migration is straightforward.

### Negative

- **Performance overhead**: The transpiled Go code is 5-20% slower than native C SQLite in benchmarks. For Sovereign's expected scale (single server, hundreds of users, I/O-bound workload), this overhead is imperceptible.
- **Larger binary size**: The transpiled SQLite code adds approximately 10-15 MB to the Go binary. Acceptable given the benefits.
- **Less ecosystem familiarity**: `modernc.org/sqlite` is less widely used than `mattn/go-sqlite3`, meaning fewer Stack Overflow answers and community resources. The `database/sql` API is standard, though, so most Go database patterns apply directly.

### Neutral

- The `modernc.org/sqlite` project is actively maintained and tracks SQLite releases, typically updating within weeks of a new SQLite version.
- Since the driver uses `database/sql`, we can use standard Go database patterns including prepared statements, transactions, and connection pooling.
